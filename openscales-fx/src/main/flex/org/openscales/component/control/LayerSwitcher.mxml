<?xml version="1.0" encoding="utf-8"?>
<control:Control xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:control="org.openscales.component.control.*">

<mx:Script>
	<![CDATA[
		import org.openscales.core.events.MapEvent;
		import org.openscales.core.events.LayerEvent;
		import mx.events.IndexChangedEvent;
		import org.openscales.core.layer.Layer;
		import org.openscales.core.Map;
		
		[Bindable]
		private var layerArray:Array = new Array();
		
		override public function set map(value:Map):void
		{
			super.map = value;	
			if(map != null)
			{
				this.map.addEventListener(LayerEvent.LAYER_ADDED,this.refresh);
				this.map.addEventListener(LayerEvent.LAYER_CHANGED,this.refresh);
				this.map.addEventListener(LayerEvent.LAYER_REMOVED,this.refresh);
			}
		}
		
	 	public function refresh(event:LayerEvent):void
		{
			this.lArray = this.map.layers;
		} 
		
		public function set lArray(value:Array):void
		{
			layerArray = value;
			displayedBaseLayers.dataProvider = GetBaseLayer();
			displayedBaseLayers.height = (GetBaseLayer().length)*100;
			displayedOverlays.dataProvider = GetOverlays();
			displayedOverlays.height = (GetOverlays().length)*100;
		}
		
		 public function GetBaseLayer():Array
		{
			var baseLayerArray:Array = new Array();;
			
			for(var i:int=0;i<layerArray.length;i++)
			{
				var layer:Layer = layerArray[i] as Layer;
				if(layer.isBaseLayer == true)
					baseLayerArray.push(layer);
			}
			baseLayerArray.length;
			return baseLayerArray;
			
		} 
		
		public function GetOverlays():Array
		{
			var overlaysArray:Array = new Array();;
			
			for(var k:int=0;k<layerArray.length;k++)
			{
				var layer:Layer = layerArray[k] as Layer;
				if(layer.isBaseLayer == false)
					overlaysArray.push(layer);
			}
			return (overlaysArray.reverse());
		}
		
		public function ChangeLayerOrder(overlaysArray:Array):void
		{
			var ecart:int = displayedOverlays.calculateDropIndex() - displayedOverlays.selectedIndex;
			
			if(ecart > 0)
			{
				(displayedOverlays.selectedItem as Layer).zindex = (displayedOverlays.selectedItem as Layer).zindex - (ecart-1);
			}
			if(ecart < 0)			
			{
				(displayedOverlays.selectedItem as Layer).zindex = (displayedOverlays.selectedItem as Layer).zindex + ecart +2;
			}
		}
		
	]]>
</mx:Script>

	<mx:Text id="baseLayer" text="Base Layer"/>
	
	<mx:List id="displayedBaseLayers" y="{baseLayer.y + 30}" height="{100}" width="250" dataProvider="{GetBaseLayer()}" itemRenderer="org.openscales.component.control.VBoxLayerSwitcher" labelField="BaseLayer"/>
	
	<mx:Text id="overlays" text="Overlays" y="{displayedBaseLayers.height + 50}"/>
	<mx:List id="displayedOverlays" y="{displayedBaseLayers.height + 80}" width="250" dataProvider="{GetOverlays()}" itemRenderer="org.openscales.component.control.VBoxLayerSwitcher" labelField="Overlays" dragEnabled="true" dropEnabled="true" dragMoveEnabled="true" dragDrop="ChangeLayerOrder(GetOverlays())"/>
</control:Control>

